{"version":3,"file":"bundle.js","sources":["src/h.ts","src/index.tsx"],"sourcesContent":["\r\nconst h = function h(tagName: string, attributes, ...children: HTMLElement[]): HTMLElement {\r\n    const el = document.createElement(tagName)\r\n    attributes && Object.keys(attributes).map(k => {\r\n        const v = attributes[k]\r\n        if (v) {\r\n            switch (k) {\r\n                case 'htmlFor':\r\n                    el.setAttribute('for', v);\r\n                    break;\r\n                case 'style':\r\n                    Object.assign(el.style, v);\r\n                    break;\r\n                default:\r\n                    if (/^on/.test(k)) {\r\n                        el.addEventListener(k.substring(2).toLowerCase(), v)\r\n                    } else {\r\n                        el[k] = v\r\n                    }\r\n            }\r\n        }\r\n    })\r\n    children.map(c => {\r\n        if (c instanceof HTMLElement) {\r\n            el.appendChild(c)\r\n        } else {\r\n            el.innerHTML = c\r\n        }\r\n    })\r\n    return el\r\n}\r\n\r\nexport default h","import h from './h'\r\n\r\nconst NAME = 'image-crop-picker'\r\n\r\nconst cssText = `\r\n    .${NAME} {\r\n        margin: 0 auto;\r\n        width: 300px;\r\n    }\r\n    .${NAME} > label {\r\n        display: block;\r\n        padding: 2em;\r\n        margin: .5em 0;\r\n        border: 2px dashed;\r\n        border-radius: 7px;\r\n        cursor: pointer;\r\n        opacity: .8;\r\n    }\r\n    .${NAME} > label:hover {\r\n        opacity: 1;\r\n    }\r\n    .${NAME} > canvas {\r\n        display: block;\r\n        margin: 0 auto;\r\n    }\r\n`\r\nclass ImageCropPicker extends HTMLElement {\r\n    \r\n    getAllAttributes = () => [].slice.call(this.attributes).reduce((m, attr) => {\r\n        let { name, value } = attr\r\n        if (value) {\r\n            switch (attr.name) {\r\n                case 'zoomRatio':\r\n                case 'maxSize':\r\n                case 'width':\r\n                case 'height':\r\n                    value = Number(value);\r\n                    break;\r\n            }\r\n            m[name] = value\r\n        }\r\n        return m\r\n    }, {})\r\n\r\n    constructor() {\r\n        super();\r\n        const t = this\r\n        const { className = '', title = '', innerText } = t\r\n        const { accept = 'image/*', zoomRatio = .05, maxSize = 102400, name = NAME, width = 300, height = 200 } = t.getAllAttributes()\r\n\r\n        const canvas: HTMLCanvasElement = <canvas tabIndex=\"-1\" width={width} height={height}></canvas>\r\n        const ctx = canvas.getContext('2d')\r\n\r\n        const preventDefault = (e:Event) => {\r\n            e.stopPropagation()\r\n            e.preventDefault()\r\n        }\r\n\r\n        let img\r\n        let zoom = 1\r\n        let position = {\r\n            x: 0,\r\n            y: 0\r\n        }\r\n        const drawImage = () => {\r\n            const { x, y } = position\r\n            const { width, height } = img\r\n            ctx.clearRect(0, 0, width, height)\r\n            ctx.drawImage(img, 0, 0, width, height, x, y, width * zoom, height * zoom)\r\n            canvas.toBlob(result => {\r\n                t['files'] = [result]\r\n                t.dispatchEvent(new CustomEvent('change'))\r\n            })\r\n        }\r\n        const onPickFile = function (e) {\r\n            const file = (e.target.files || e.dataTransfer.files)[0]\r\n            if (file.type.indexOf(accept.replace('*','')) === -1) {\r\n                alert(\"file type invalid!\");\r\n            }\r\n            const src = URL.createObjectURL(file)\r\n            img = new Image()\r\n            img.addEventListener('load', e => {\r\n                drawImage()\r\n            })\r\n            img.src = src\r\n            canvas.focus()\r\n            preventDefault(e)\r\n        }\r\n        \r\n        canvas.addEventListener('mousewheel', e => {\r\n            if (e.deltaY > 0) {\r\n                zoom += zoomRatio\r\n            } else {\r\n                zoom -= zoomRatio\r\n            }\r\n            drawImage()\r\n            preventDefault(e)\r\n        })\r\n        canvas.addEventListener('keydown', e => {\r\n            switch (e.keyCode) {\r\n                case 37: position.x--; break;\r\n                case 38: position.y--; break;\r\n                case 39: position.x++; break;\r\n                case 40: position.y++; break;\r\n                case 187: zoom += zoomRatio; break;\r\n                case 189: zoom -= zoomRatio; break;\r\n            }\r\n            drawImage()\r\n            preventDefault(e)\r\n        }, false)\r\n\r\n        let touchPosition = null\r\n        const touchStart = (e) => {\r\n            const ev = e.touches ? e.touches[0] : e\r\n            const { clientX, clientY } = ev\r\n            touchPosition = { clientX, clientY }\r\n        }\r\n        const touchMove = (e) => {\r\n            if (touchPosition) {\r\n                const ev = e.touches ? e.touches[0] : e\r\n                const { clientX, clientY } = ev\r\n                position.x += clientX - touchPosition.clientX\r\n                position.y += clientY - touchPosition.clientY\r\n                drawImage()\r\n                touchPosition = { clientX, clientY }\r\n            }\r\n        }\r\n        const touchEnd = (e) => {\r\n            touchPosition = null\r\n        }\r\n        canvas.addEventListener('touchstart', touchStart)\r\n        canvas.addEventListener('mousedown', touchStart)\r\n        canvas.addEventListener('touchmove', touchMove)\r\n        canvas.addEventListener('mousemove', touchMove)\r\n        canvas.addEventListener('touchend', touchEnd)\r\n        canvas.addEventListener('mouseup', touchEnd)\r\n\r\n        const label = <label onDragEnter={preventDefault} onDragOver={preventDefault} onDragEnd={preventDefault} onDrop={onPickFile}>\r\n            <input type=\"file\" accept={accept} name={name} style={{ display: 'none' }} onChange={onPickFile}/>\r\n            <span>{innerText.trim() || 'Click or Drop image file here'}</span>\r\n        </label>\r\n        \r\n        const root = this.attachShadow({\r\n            mode: 'open'\r\n        })\r\n        root.appendChild(<style>{cssText}</style>)\r\n        root.appendChild(<div className={`${NAME} ${className}`} title={title}>\r\n            {label}\r\n            {canvas}\r\n        </div>)\r\n    }\r\n\r\n}\r\n\r\ncustomElements.define(NAME, ImageCropPicker);\r\n"],"names":[],"mappings":"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"}